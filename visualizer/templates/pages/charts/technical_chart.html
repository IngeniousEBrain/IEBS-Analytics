{% extends 'base.html' %}
{% load static %}
{% block head %}
{{ block.super }}
<style>
.am5-tooltip-container {
    display: none;
}

#fileNameLabel {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: calc(100% - 120px); /* Adjust the maximum width to accommodate other elements */
    }
</style>
{% endblock %}
{% block content %}

<div class="tab-container">
    <a href="{% url 'competitor_charts' project_id %}" class="tab-link active">
        <span class="tab-icon">&#8592;</span>
        Competitor Charts
    </a>
    <a href="{% url 'bibliographic_charts' project_id %}" class="tab-link active">
        <span class="tab-icon">&#8592;</span>
        Bibliographic Charts
    </a>
</div>
<div class="row align-items-center">
    <div class="col-lg-8">
        <h4>Technical Focus Chart - <b>({{proj_name}})</b></h4>
    </div>
    <div class="col-lg-4">
        <form method="post" action="/tech_charts/{{ project_id }}/" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Level</span>
                </div>
                <input type="number" class="form-control" name="level" min="1" required>
            </div>
            <br>
            <div class="input-group">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="excelFile" accept=".xlsx,.xls,.ods,.xlsm"
                           name="technical_excel" onchange="updateFileName(this)">
                    <label class="custom-file-label" for="excelFile" id="fileNameLabel" title="Choose File">
                        Choose File
                    </label>
                </div>
                <div class="input-group-append">
                    <button type="submit" class="btn btn-primary btn-round">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if get_all_data %}
<div class="text-right">
    <a href="#">
        <i class="fas fa-file-download"></i> Download Demo Excel
    </a>
</div>
<!--NESTED DONUT-->
<div class="row justify-content-center">
    <div class="col-md-12">
     <div class="card">
  <div class="card-header">
            <!-- Render dynamic heading using Django template variable -->
            <h5 class="card-title"><b><span id="heading-{{ chart_id }}">{{ chart_heading }}</span></b></h5>
            <!-- Edit button to toggle between view and edit mode -->
            <button class="btn btn-sm btn-primary edit-heading" data-chart-id="{{ chart_id }}">Edit</button>
        </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-12">
        <div id="chartdiv" style="height: 550px; overflow: auto; width: 100%;"></div>
      </div>
    </div>
  </div>
</div>

        <div class="row mt-4">
            <!-- Table Section (40%) -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div style="max-height: 300px; overflow-y: auto;">
<!--                            <table class="table table-sm table-bordered">-->
<!--                                <thead style="background-color: #808080">-->
<!--                                <tr>-->
<!--                                    <th class="text-center small">CPC</th>-->
<!--                                    <th class="text-center small">Count</th>-->
<!--                                    <th class="text-center small">Actions</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                <tr>-->
<!--                                    <td class="text-center small">data</td>-->
<!--                                    <td class="text-center small">data</td>-->
<!--                                    <td class="text-center small">-->
<!--                                        <div class="d-flex justify-content-center">-->
<!--                                            <button class="btn btn-secondary btn-xs mx-1"-->
<!--                                                    onclick="indCpcDataView('{{key}}','{{project_id}}')">-->
<!--                                                <i class="fa fa-eye" aria-hidden="true"></i>-->
<!--                                            </button>-->
<!--                                            <button class="btn btn-primary btn-xs mx-1"-->
<!--                                                    onclick="downloadIndCpc('')"><i-->
<!--                                                    class="fas fa-file-download" aria-hidden="true"></i>-->
<!--                                            </button>-->
<!--                                        </div>-->
<!--                                    </td>-->
<!--                                </tr>-->
<!--                                </tbody>-->
<!--                            </table>-->
                        </div>
                        <div class="text-center mt-2">
<!--                            <button class="btn btn-secondary btn-xs"-->
<!--                                    onclick="openCpcDataView('')">View-->
<!--                            </button>-->
<!--                            <button class="btn btn-primary btn-xs"-->
<!--                                    onclick="downloadTopCPC('')">-->
<!--                                Download-->
<!--                            </button>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--NESTED DONUT table end-->
<!--3D PIE CHART-->

<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-title"><b>Other Spatial Omics Column Segmentation</b></h5>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div id="chartQdiv" style="height: 450px; width: 100%; overflow: 'visible';"></div>
                    </div>
                </div>
            </div>
        </div>
        <!--3D PIE CHART Table-->
        <div class="row mt-4">
            <!-- Table Section (40%) -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div style="max-height: 300px; overflow-y: auto;">
<!--                            <table class="table table-sm table-bordered">-->
<!--                                <thead style="background-color: #808080">-->
<!--                                <tr>-->
<!--                                    <th class="text-center small">CPC</th>-->
<!--                                    <th class="text-center small">Count</th>-->
<!--                                    <th class="text-center small">Actions</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                    <tr>-->
<!--                                        <td class="text-center small">data</td>-->
<!--                                        <td class="text-center small">-->
<!--                                            <div class="d-flex justify-content-center">-->
<!--                                                <button class="btn btn-secondary btn-xs mx-1"-->
<!--                                                        onclick="indCpcDataView('{{key}}','{{project_id}}')">-->
<!--                                                    <i class="fa fa-eye" aria-hidden="true"></i>-->
<!--                                                </button>-->
<!--                                                <button class="btn btn-primary btn-xs mx-1"-->
<!--                                                        onclick="downloadIndCpc('')"><i-->
<!--                                                        class="fas fa-file-download" aria-hidden="true"></i>-->
<!--                                                </button>-->
<!--                                            </div>-->
<!--                                        </td>-->
<!--                                    </tr>-->
<!--                                </tbody>-->
<!--                            </table>-->
                        </div>
                        <div class="text-center mt-2">
<!--                            <button class="btn btn-secondary btn-xs"-->
<!--                                    onclick="openCpcDataView('')">View-->
<!--                            </button>-->
<!--                            <button class="btn btn-primary btn-xs"-->
<!--                                    onclick="downloadTopCPC('')">-->
<!--                                Download-->
<!--                            </button>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--3D PIE CHART Table end-->
<!--bar cart-->
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-title"><b>Sequencing Techniques vs Patent family count</b></h5>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div id="barchartdiv" style="height: 500px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <!-- Table Section (40%) -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div style="max-height: 300px; overflow-y: auto;">
<!--                            <table class="table table-sm table-bordered">-->
<!--                                <thead style="background-color: #808080">-->
<!--                                <tr>-->
<!--                                    <th class="text-center small">CPC</th>-->
<!--                                    <th class="text-center small">Count</th>-->
<!--                                    <th class="text-center small">Actions</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                <tr>-->
<!--                                    <td class="text-center small">data</td>-->
<!--                                    <td class="text-center small">data</td>-->
<!--                                    <td class="text-center small">-->
<!--                                        <div class="d-flex justify-content-center">-->
<!--                                            <button class="btn btn-secondary btn-xs mx-1"-->
<!--                                                    onclick="indCpcDataView('{{key}}','{{project_id}}')">-->
<!--                                                <i class="fa fa-eye" aria-hidden="true"></i>-->
<!--                                            </button>-->
<!--                                            <button class="btn btn-primary btn-xs mx-1"-->
<!--                                                    onclick="downloadIndCpc('')"><i-->
<!--                                                    class="fas fa-file-download" aria-hidden="true"></i>-->
<!--                                            </button>-->
<!--                                        </div>-->
<!--                                    </td>-->
<!--                                </tr>-->
<!--                                </tbody>-->
<!--                            </table>-->
                        </div>
                        <div class="text-center mt-2">
<!--                            <button class="btn btn-secondary btn-xs"-->
<!--                                    onclick="openCpcDataView('')">View-->
<!--                            </button>-->
<!--                            <button class="btn btn-primary btn-xs"-->
<!--                                    onclick="downloadTopCPC('')">-->
<!--                                Download-->
<!--                            </button>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--bar cart ends here-->
<!--3d pie chart-->
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <h5 class="card-title"><b>Other Sequencing Techniques vs Patent family count</b></h5>
            <div class="card-body">
                <div class="row">
                    <!-- Chart Section (60%) -->
                    <div class="col-md-12">
                        <div id="piechartdiv" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <!-- Table Section (40%) -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div style="max-height: 300px; overflow-y: auto;">
<!--                            <table class="table table-sm table-bordered">-->
<!--                                <thead style="background-color: #808080">-->
<!--                                <tr>-->
<!--                                    <th class="text-center small">CPC</th>-->
<!--                                    <th class="text-center small">Count</th>-->
<!--                                    <th class="text-center small">Actions</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                <tr>-->
<!--                                    <td class="text-center small">data</td>-->
<!--                                    <td class="text-center small">data</td>-->
<!--                                    <td class="text-center small">-->
<!--                                        <div class="d-flex justify-content-center">-->
<!--                                            <button class="btn btn-secondary btn-xs mx-1"-->
<!--                                                    onclick="indCpcDataView('{{key}}','{{project_id}}')">-->
<!--                                                <i class="fa fa-eye" aria-hidden="true"></i>-->
<!--                                            </button>-->
<!--                                            <button class="btn btn-primary btn-xs mx-1"-->
<!--                                                    onclick="downloadIndCpc('')"><i-->
<!--                                                    class="fas fa-file-download" aria-hidden="true"></i>-->
<!--                                            </button>-->
<!--                                        </div>-->
<!--                                    </td>-->
<!--                                </tr>-->
<!--                                </tbody>-->
<!--                            </table>-->
                        </div>
                        <div class="text-center mt-2">
<!--                            <button class="btn btn-secondary btn-xs"-->
<!--                                    onclick="openCpcDataView('')">View-->
<!--                            </button>-->
<!--                            <button class="btn btn-primary btn-xs"-->
<!--                                    onclick="downloadTopCPC('')">-->
<!--                                Download-->
<!--                            </button>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<img id="logo" src="{% static 'img/No data-amico.svg' %}" width="100%" height="70%">
    <div style="text-align: center;">
        <b>No Data uploaded yet!</b>
    </div>
{% endif %}
<!--3d pie chart ends here-->
{% endblock %}
{% block scripts %}
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.amcharts.com/lib/5/hierarchy.js"></script>
<script>
am5.ready(function() {
    // Create root element
    var root = am5.Root.new("chartdiv");

    // Set themes
    root.setThemes([am5themes_Animated.new(root)]);

    // Create wrapper container
    var container = root.container.children.push(
        am5.Container.new(root, {
            width: am5.percent(100),
            height: am5.percent(100),
            layout: root.verticalLayout,
        })
    );

    // Create series
    var series = container.children.push(
        am5hierarchy.Sunburst.new(root, {
            singleBranchOnly: true,
            downDepth: 3,
            initialDepth: 2,
            valueField: "value",
            categoryField: "name",
            childDataField: "children",
            maxDepth: 2,
        })
    );

    // Custom label formatter
    series.labels.template.setAll({
        tooltipText: "{name}",
        maxWidth: 120, // Adjust this value as needed
        truncate: true, // Enable text truncation
        ellipsis: "...",
        wrap: true, // Enable text wrapping
        textAlign: "center", // Align text to the center
        paddingTop: 10, // Add some top padding
        paddingBottom: 10, // Add some bottom padding
        radius: 10, // Add some radius to the label background
        fontSize: 12, // Adjust font size as needed
    });

    // Adjust label position based on text length
setTimeout(function() {
    series.labels.template.adapters.add("centerX", function(centerX, target) {
        if (target.labelShape) {
            const labelWidth = target.labelShape.measuredWidth;
            const radius = target.dataItem.get("radius");
            const adjustment = labelWidth / 2 + radius * 0.2;
            return centerX - adjustment;
        }
        return centerX;
    });
}, 100); // Delay of 100 milliseconds

    // Your data
    const data = {{get_all_data|safe}}
    delete data["Publication Number"];

    series.data.setAll([data]);
    series.set("selectedDataItem", series.dataItems[0]);

    // Make stuff animate on load
    series.appear(1000, 100);
});
<!-- Chart code -->
am4core.ready(function() {

// Themes begin
am4core.useTheme(am4themes_animated);
// Themes end

var chart = am4core.create("chartQdiv", am4charts.PieChart3D);
chart.hiddenState.properties.opacity = 0; // this creates initial fade-in
var encodedData = '{{others_count}}';

// Create a temporary DOM element
var tempElement = document.createElement('div');

// Set its innerHTML to the encoded data
tempElement.innerHTML = encodedData;

// Get the decoded data from the innerText property
var decodedData = tempElement.innerText;

// Now you can set chart.data with the decoded data
chart.data = JSON.parse(decodedData);
chart.innerRadius = am4core.percent(40);
chart.depth = 120;
chart.legend = new am4charts.Legend();
var series = chart.series.push(new am4charts.PieSeries3D());
series.dataFields.value = "litres";
series.dataFields.depthValue = "litres";
series.dataFields.category = "category";
series.slices.template.cornerRadius = 5;
series.colors.step = 3;

});
//============bar chart=================
am4core.ready(function() {
  // Themes begin
  am4core.useTheme(am4themes_animated);
  // Themes end

  // Create chart instance
  var chart = am4core.create("barchartdiv", am4charts.XYChart3D);  // Ensure "barchartdiv" exists in your HTML

  // Reshape data (replace with your data processing logic)
  var data = Object.entries({{all_child_categories_count|safe}});
  data = data.map(function(entry) {
    return {
      "category": entry[0],
      "value": entry[1]
    };
  });

  // Assign the data to the chart's data property
  chart.data = data;

  // Create axes
  var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
  categoryAxis.dataFields.category = "category";
  categoryAxis.renderer.inversed = true;
  categoryAxis.renderer.minGridDistance = 40;
  var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());

  // Create series
  var series = chart.series.push(new am4charts.ColumnSeries3D());
  series.dataFields.valueX = "value";
  series.dataFields.categoryY = "category";
  series.name = "Count";
  series.columns.template.tooltipText = "{category}: {valueX}";
  series.columns.template.column3D.stroke = am4core.color("#fff");
  series.columns.template.column3D.strokeOpacity = 0.2;

  // Handle potential large number of categories (optional)
  if (data.length > 20) {
    // Enable horizontal scrolling for many categories
    chart.scrollbarY = new am4core.Scrollbar();
    chart.scrollbarY.parent = chart.rightContainer;
  }
});

//===================pie chart 3D===========
am4core.ready(function() {
    // Themes begin
    am4core.useTheme(am4themes_animated);
    // Themes end

    var chart = am4core.create("piechartdiv", am4charts.PieChart3D);
    chart.hiddenState.properties.opacity = 0; // this creates initial fade-in

    chart.legend = new am4charts.Legend();

    // Assign the data from the backend
    chart.data = {{ others_category_count|safe }};
    var series = chart.series.push(new am4charts.PieSeries3D());
    series.dataFields.value = "litres"; // Specify the value field
    series.dataFields.category = "child_cat_name"; // Specify the category field

});

  function updateFileName(input) {
        var fileNameLabel = document.getElementById('fileNameLabel');
        var fileName = input.files[0].name;
        fileNameLabel.innerHTML = fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName;
    }


    $('.edit-heading').click(function() {
        var chartId = $(this).data('chart-id');
        var headingElement = $('#heading-' + chartId);
        var currentHeading = headingElement.text().trim();

        // Toggle between view and edit mode
        if ($(this).text() === 'Edit') {
            // Replace the span with an input field for editing
            var inputField = $('<input type="text" class="form-control">').val(currentHeading);
            headingElement.html(inputField);
        } else {
            // Switch back to view mode and update the heading
            var newHeading = headingElement.find('input').val().trim();
            if (newHeading !== '') {
                headingElement.html('<span>' + newHeading + '</span>');
                // Perform Ajax request to save the updated heading to the server
                // Example: $.post('/create_chart_heading/', { chart_id: chartId, new_heading: newHeading });
            } else {
                // If input is empty, revert back to the original heading
                headingElement.html('<span>' + currentHeading + '</span>');
            }
        }

        // Toggle button text between "Edit" and "Save"
        $(this).text($(this).text() === 'Edit' ? 'Save' : 'Edit');
    });
</script>
{% endblock %}